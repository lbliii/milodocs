{{/* Advanced JavaScript bundling with environment-specific optimizations */}}
{{- $jsResources := resources.Match "js/*.js" -}}
{{- if $jsResources -}}
  {{- $bundleName := printf "js/bundle-%s.js" hugo.Environment -}}
  
  {{/* Environment-specific build options */}}
  {{- $opts := dict "target" "es2018" "format" "esm" -}}
  {{/* Define production-like environments that should get minification */}}
  {{- $isProductionBuild := or hugo.IsProduction (in (slice "nvidia" "enterprise" "open-source") hugo.Environment) -}}
  
  {{- if $isProductionBuild -}}
    {{- $opts = $opts | merge (dict "minify" true "sourcemap" "external") -}}
  {{- else -}}
    {{- $opts = $opts | merge (dict "sourcemap" "inline") -}}
  {{- end -}}
  
  {{- if $isProductionBuild -}}
    {{/* Production: Optimized bundle with integrity */}}
    {{- $jsBundle := $jsResources | resources.Concat $bundleName | js.Build $opts | fingerprint "sha512" -}}
    {{- if eq hugo.Environment "offline" -}}
      <script type="module" src="{{ $jsBundle.RelPermalink }}" defer></script>
    {{- else -}}
      <script type="module" src="{{ $jsBundle.RelPermalink }}" integrity="{{ $jsBundle.Data.Integrity }}" crossorigin="anonymous" defer></script>
    {{- end -}}
  {{- else -}}
    {{/* Development: Fast builds with debugging */}}
    {{- $jsBundle := $jsResources | resources.Concat $bundleName | js.Build $opts -}}
    <script type="module" src="{{ $jsBundle.RelPermalink }}" defer></script>
    {{- if site.Params.debug -}}
      <!-- JS Debug: Bundle contains {{ len $jsResources }} files for {{ hugo.Environment }} environment -->
    {{- end -}}
  {{- end -}}
  
  {{/* Environment-specific JavaScript globals */}}
  {{/* Expose env as JSON for early access without inline <script> */}}
  <script type="application/json" id="hugo-environment-json">
    {
      "environment": "{{ hugo.Environment }}",
      "isProduction": {{ $isProductionBuild }},
      "debug": {{ site.Params.debug | default false }},
      "version": "{{ site.Params.version.major | default 0 }}.{{ site.Params.version.minor | default 0 }}.{{ site.Params.version.patch | default 0 }}",
      "baseURL": "{{ site.BaseURL }}",
      "buildTime": "{{ now.UnixMilli }}"
    }
  </script>
  {{- $envInit := resources.Get "js/hugo-env-init.js" | js.Build (dict "target" "es2018" "format" "iife") -}}
  <script src="{{ $envInit.RelPermalink }}" defer></script>
{{- else -}}
  {{- warnf "JavaScript: No JS files found in assets/js/ for environment '%s'" hugo.Environment -}}
{{- end -}}

{{/* Avoid loading any external scripts in offline env */}}
{{- if and (ne hugo.Environment "offline") false -}}
  <script src="https://unpkg.com/lunr/lunr.js" crossorigin="anonymous" defer></script>
{{- end -}}
