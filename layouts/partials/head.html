<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#76B900" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">

{{/* Modern Favicon System - 2024 Best Practices */}}
{{/* Check for custom favicon params, fallback to Milo defaults */}}
{{- $faviconIco := site.Params.favicon.ico | default "/favicon.ico" -}}
{{- $faviconSvg := site.Params.favicon.svg | default "/icon.svg" -}}
{{- $appleTouchIcon := site.Params.favicon.appleTouchIcon | default "/apple-touch-icon.png" -}}
{{- $manifest := site.Params.favicon.manifest | default "/manifest.webmanifest" -}}

<link rel="icon" href="{{ $faviconIco | relURL }}" sizes="32x32">
<link rel="icon" href="{{ $faviconSvg | relURL }}" type="image/svg+xml">  
<link rel="apple-touch-icon" href="{{ $appleTouchIcon | relURL }}">
<link rel="manifest" href="{{ $manifest | relURL }}">

{{/* SEO Meta Tags */}}
<title>{{ if .IsHome }}{{ site.Title }}{{ else }}{{ printf "%s | %s" .Title site.Title }}{{ end }}</title>
<meta name="title" content="{{with .Parent}}{{.Title}} - {{end}}{{ .Title }}" />
{{- $description := "" -}}
{{- if .Description -}}
  {{- $description = .Description -}}
{{- else if .Summary -}}
  {{- $description = .Summary | plainify | truncate 160 -}}
{{- else -}}
  {{- $description = site.Params.description -}}
{{- end -}}
<meta name="description" content="{{ $description }}" />

{{/* Early JS init moved to bundled asset: assets/js/early/early-init.js */}}
{{- $early := resources.Get "js/early/early-init.js" | js.Build (dict "target" "es2018" "format" "iife") -}}
<script src="{{ $early.RelPermalink }}" defer></script>

{{/* Critical inline CSS to prevent flicker during navigation */}}
<style>
  /* Prevent transitions during initialization */
  html.no-transitions,
  html.no-transitions * {
    transition: none !important;
  }
  
  /* Critical theme variables to prevent flicker */
  :root {
    --color-text-primary: #111827;
    --color-text-secondary: #6b7280;
    --color-bg-primary: #ffffff;
    --color-bg-secondary: #f9fafb;
    --color-surface: #ffffff;
  }
  
  .dark {
    --color-text-primary: #f9fafb;
    --color-text-secondary: #d1d5db;
    --color-bg-primary: #111827;
    --color-bg-secondary: #1f2937;
    --color-surface: #1f2937;
  }
  
  /* Critical base styles to prevent layout shift */
  body {
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  
  html.no-transitions body {
    transition: none !important;
  }
</style>

{{/* Enhanced Keywords - combining page keywords with automatic extraction */}}
{{- $keywords := slice -}}
{{- with .Keywords -}}
  {{- $keywords = . -}}
{{- else -}}
  {{- with .Params.tags -}}
    {{- $keywords = . -}}
  {{- end -}}
  {{- with .Section -}}
    {{- $keywords = $keywords | append . -}}
  {{- end -}}
{{- end -}}
{{- if $keywords -}}
  <meta name="keywords" content="{{ delimit $keywords ", " }}" />
{{- end -}}

{{/* Author and publication info */}}
{{ with .Params.author }}<meta name="author" content="{{ . }}" />{{ end }}
{{- with .Date -}}
  <meta name="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
{{- end -}}
{{- with .Lastmod -}}
  <meta name="article:modified_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
{{- end -}}

{{/* Robots and Sitemap directives */}}
{{- $robots := "index,follow" -}}
{{- with .Sitemap -}}
  {{- if .Priority -}}
    {{- $robots = printf "%s,max-snippet:-1,max-image-preview:large" $robots -}}
  {{- end -}}
{{- end -}}

{{/* Only apply noindex in specific cases to avoid blocking indexing */}}
{{- if and .Draft (ne hugo.Environment "production") -}}
  {{/* Only block drafts in non-production environments */}}
  {{- $robots = "noindex,nofollow" -}}
{{- else if .Params.noindex -}}
  {{/* Allow explicit noindex via page params */}}
  {{- $robots = "noindex,follow" -}}
{{- else if and .ExpiryDate (.ExpiryDate.Before now) -}}
  {{/* Block expired content */}}
  {{- $robots = "noindex,follow" -}}
{{- else if .Params.hidden -}}
  {{/* Block pages marked as hidden */}}
  {{- $robots = "noindex,nofollow" -}}
{{- end -}}
<meta name="robots" content="{{ $robots }}" />

{{/* Language and Translation Links */}}
{{- if .IsTranslated -}}
  {{- range .AllTranslations -}}
    <link rel="alternate" hreflang="{{ .Language.Lang }}" href="{{ .Permalink }}" />
  {{- end -}}
{{- end -}}

{{/* Open Graph */}}
<meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}" />
<meta property="og:title" content="{{ .Title }}" />
<meta property="og:description" content="{{ $description }}" />
<meta property="og:url" content="{{ .Permalink }}" />
<meta property="og:site_name" content="{{ site.Title }}" />
<meta property="og:locale" content="{{ .Language.Lang | default "en" }}" />
{{ with .Params.image }}<meta property="og:image" content="{{ if eq hugo.Environment "offline" }}{{ . | relURL }}{{ else }}{{ . | absURL }}{{ end }}" />{{ end }}
{{- if .IsPage -}}
  {{- with .Date -}}
    <meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
  {{- end -}}
  {{- with .Lastmod -}}
    <meta property="article:modified_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}" />
  {{- end -}}
  {{- with .Params.author -}}
    <meta property="article:author" content="{{ . }}" />
  {{- end -}}
  {{- with .Section -}}
    <meta property="article:section" content="{{ . }}" />
  {{- end -}}
  {{- with .Params.tags -}}
    {{- range . -}}
      <meta property="article:tag" content="{{ . }}" />
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* Twitter Card */}}
<meta name="twitter:card" content="summary{{ with .Params.image }}_large_image{{ end }}" />
<meta name="twitter:title" content="{{ .Title }}" />
<meta name="twitter:description" content="{{ $description }}" />
{{ with .Params.image }}<meta name="twitter:image" content="{{ if eq hugo.Environment "offline" }}{{ . | relURL }}{{ else }}{{ . | absURL }}{{ end }}" />{{ end }}
{{ with site.Params.social.twitter }}<meta name="twitter:site" content="@{{ . }}" />{{ end }}

{{/* Canonical URL - Prefer relative canonical for offline builds */}}
{{- $canonicalURL := .Permalink -}}
{{- if eq hugo.Environment "offline" -}}
  {{- $canonicalURL = .RelPermalink -}}
{{- else if not (strings.HasPrefix $canonicalURL "http") -}}
  {{- $canonicalURL = printf "%s%s" (site.BaseURL | strings.TrimSuffix "/") .RelPermalink -}}
{{- end -}}
<link rel="canonical" href="{{ $canonicalURL }}" />

{{/* JSON-LD Structured Data */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": {{ if .IsPage }}"Article"{{ else if .IsHome }}"Organization"{{ else }}"WebPage"{{ end }},
  "headline": "{{ .Title | jsonify }}",
  "description": {{ $description | jsonify }},
  "url": "{{ .Permalink }}",
  {{- if .IsPage -}}
    {{- with .Date -}}
      "datePublished": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
    {{- end -}}
    {{- with .Lastmod -}}
      "dateModified": "{{ .Format "2006-01-02T15:04:05Z07:00" }}",
    {{- end -}}
    {{- with .Params.author -}}
      "author": {
        "@type": "Person",
        "name": "{{ . }}"
      },
    {{- end -}}
    {{- with .WordCount -}}
      "wordCount": {{ . }},
    {{- end -}}
  {{- end -}}
  "publisher": {
    "@type": "Organization",
    "name": "{{ site.Title }}",
    "url": "{{ site.BaseURL }}"
    {{- with site.Params.logo -}}
      ,"logo": {
        "@type": "ImageObject",
        "url": "{{ if eq hugo.Environment "offline" }}{{ . | relURL }}{{ else }}{{ . | absURL }}{{ end }}"
      }
    {{- end -}}
  }
}
</script>

{{/* Generator */}}
{{ hugo.Generator }}

{{/* Resource hints for performance (skip in offline) */}}
{{- if ne hugo.Environment "offline" -}}
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="dns-prefetch" href="//unpkg.com">
{{- end -}}

{{ partialCached "head/css.html" . }}
{{ partialCached "head/js.html" . }}
