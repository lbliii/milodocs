{{- $schema := .schema -}}
{{- $spec := .spec -}}
{{- $level := .level | default 0 -}}
{{- $maxLevel := 5 -}}

<!-- Prevent infinite recursion -->
{{ if gt $level $maxLevel }}
  <div class="schema-truncated">
    <span class="truncated-message">Schema too deeply nested...</span>
  </div>
  {{ return }}
{{ end }}

<div class="schema-container" data-level="{{ $level }}">
  
  <!-- Handle $ref - only for SchemaRef types -->
  {{ if and (isset $schema "Ref") $schema.Ref }}
    {{ $fullRef := $schema.Ref }}
    {{ $parts := split $fullRef "/" }}
    {{ $refPath := "" }}
    {{ if gt (len $parts) 0 }}
      {{ $refPath = index $parts (sub (len $parts) 1) }}
    {{ else }}
      {{ $refPath = $fullRef }}
    {{ end }}
    {{ $refSchema := "" }}
    {{ if and $spec.Components $spec.Components.Schemas }}
      {{ $refSchema = index $spec.Components.Schemas $refPath }}
    {{ end }}
    {{ if not $refSchema }}
      {{ warnf "Schema resolution failed: fullRef='%s' refPath='%s'" $fullRef $refPath }}
      {{ warnf "Spec has components: %t" (isset $spec "Components") }}
      {{ if $spec.Components }}
        {{ warnf "Components has schemas: %t" (isset $spec.Components "Schemas") }}
        {{ if $spec.Components.Schemas }}
          {{ warnf "Total schemas available: %d" (len $spec.Components.Schemas) }}
          {{ $availableSchemas := slice }}
          {{ range $name, $schema := $spec.Components.Schemas }}
            {{ if lt (len $availableSchemas) 10 }}
              {{ $availableSchemas = $availableSchemas | append $name }}
            {{ end }}
          {{ end }}
          {{ warnf "First 10 schemas: %s" (delimit $availableSchemas ", ") }}
        {{ else }}
          {{ warnf "No schemas found in spec.Components" }}
        {{ end }}
      {{ else }}
        {{ warnf "No components found in spec" }}
      {{ end }}
    {{ end }}
    {{ if $refSchema }}
      <div class="schema-ref">
        <div class="ref-header">
          <span class="ref-label">Reference:</span>
          <code class="ref-name">{{ $refPath }}</code>
        </div>
        {{ partial "openapi/schema.html" (dict "schema" $refSchema "spec" $spec "level" (add $level 1)) }}
      </div>
    {{ else if $schema.Value }}
      {{/* If ref exists but we can't resolve it, use the actual schema value */}}
      {{ partial "openapi/schema.html" (dict "schema" $schema.Value "spec" $spec "level" (add $level 1)) }}
    {{ else }}
      <div class="schema-ref-error">
        <span class="error-message">Unable to resolve reference: {{ $fullRef }}</span>
        <div class="debug-info">
          <p><strong>Debug Info:</strong></p>
          <p>Full Reference: <code>{{ $fullRef }}</code></p>
          <p>Looking for: <code>{{ $refPath }}</code></p>
          <p>Available schemas: 
          {{ if and $spec.Components $spec.Components.Schemas }}
            {{ $schemaNames := slice }}
            {{ range $name, $schema := $spec.Components.Schemas }}
              {{ $schemaNames = $schemaNames | append $name }}
            {{ end }}
            {{ delimit $schemaNames ", " }}
          {{ else }}
            None found
          {{ end }}
          </p>
          <p>Spec components available: {{ if $spec.Components }}YES{{ else }}NO{{ end }}</p>
          <p>Spec type: {{ printf "%T" $spec }}</p>
        </div>
      </div>
    {{ end }}
    {{ return }}
  {{ end }}
  


  <!-- Schema Header -->
  <div class="schema-header">
    {{/* Handle SchemaRef vs direct Schema */}}
    {{ $actualSchema := $schema }}
    {{ if $schema.Value }}
      {{ $actualSchema = $schema.Value }}
    {{ end }}
    
    {{ with $actualSchema.Title }}
      <h6 class="schema-title">{{ . }}</h6>
    {{ end }}
    
    <div class="schema-type-info">
      {{ with $actualSchema.Type }}
        <span class="type-badge type-badge--{{ . }}">{{ . }}</span>
      {{ end }}
      {{ with $actualSchema.Format }}
        <span class="type-format">({{ . }})</span>
      {{ end }}
      {{ if $actualSchema.Nullable }}
        <span class="type-nullable">nullable</span>
      {{ end }}
      {{ if $actualSchema.ReadOnly }}
        <span class="type-readonly">read-only</span>
      {{ end }}
      {{ if $actualSchema.WriteOnly }}
        <span class="type-writeonly">write-only</span>
      {{ end }}
    </div>
  </div>
  
  {{ with $actualSchema.Description }}
    <div class="schema-description">{{ . | markdownify }}</div>
  {{ end }}
  
  <!-- Schema Constraints -->
  {{ if or $actualSchema.Enum $actualSchema.Default $actualSchema.Example (and (isset $actualSchema "Pattern") $actualSchema.Pattern) (and (isset $actualSchema "MinLength") $actualSchema.MinLength) (and (isset $actualSchema "MaxLength") $actualSchema.MaxLength) (and (isset $actualSchema "Minimum") $actualSchema.Minimum) (and (isset $actualSchema "Maximum") $actualSchema.Maximum) (and (isset $actualSchema "MultipleOf") $actualSchema.MultipleOf) }}
    <div class="schema-constraints">
      {{ with $actualSchema.Default }}
        <div class="constraint">
          <span class="constraint-label">Default:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}
      
      {{ with $actualSchema.Example }}
        <div class="constraint">
          <span class="constraint-label">Example:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}
      
      {{ with $actualSchema.Enum }}
        <div class="constraint">
          <span class="constraint-label">Allowed values:</span>
          <div class="enum-values">
            {{ range $val := . }}
              <code class="enum-value">{{ $val }}</code>
            {{ end }}
          </div>
        </div>
      {{ end }}
      

      

      
      <!-- String constraints -->
      {{ if isset $actualSchema "Pattern" }}{{ with $actualSchema.Pattern }}
        <div class="constraint">
          <span class="constraint-label">Pattern:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}{{ end }}
      
      {{ if isset $actualSchema "MinLength" }}{{ with $actualSchema.MinLength }}
        <div class="constraint">
          <span class="constraint-label">Min Length:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}{{ end }}
      
      {{ if isset $actualSchema "MaxLength" }}{{ with $actualSchema.MaxLength }}
        <div class="constraint">
          <span class="constraint-label">Max Length:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}{{ end }}
      
      <!-- Numeric constraints -->
      {{ if isset $actualSchema "Minimum" }}{{ with $actualSchema.Minimum }}
        <div class="constraint">
          <span class="constraint-label">Minimum:</span>
          <code>{{ . }}</code>
          {{ if and (isset $actualSchema "ExclusiveMinimum") $actualSchema.ExclusiveMinimum }}
            <span class="constraint-modifier">(exclusive)</span>
          {{ end }}
        </div>
      {{ end }}{{ end }}
      
      {{ if isset $actualSchema "Maximum" }}{{ with $actualSchema.Maximum }}
        <div class="constraint">
          <span class="constraint-label">Maximum:</span>
          <code>{{ . }}</code>
          {{ if and (isset $actualSchema "ExclusiveMaximum") $actualSchema.ExclusiveMaximum }}
            <span class="constraint-modifier">(exclusive)</span>
          {{ end }}
        </div>
      {{ end }}{{ end }}
      
      {{ if isset $actualSchema "MultipleOf" }}{{ with $actualSchema.MultipleOf }}
        <div class="constraint">
          <span class="constraint-label">Multiple Of:</span>
          <code>{{ . }}</code>
        </div>
      {{ end }}{{ end }}
    </div>
  {{ end }}
  
  <!-- Object Properties -->
  {{ with $actualSchema.Properties }}
    <div class="schema-properties">
      <h6>Properties</h6>
        <div class="properties-list">
          {{ range $propName, $propSchema := . }}
            {{ $isRequired := in ($actualSchema.Required | default (slice)) $propName }}
            <div class="property-item{{ if $isRequired }} property-item--required{{ end }}">
              <div class="property-header">
                <div class="property-name">
                  <code>{{ $propName }}</code>
                  {{ if $isRequired }}
                    <span class="property-required">required</span>
                  {{ end }}
                </div>
              </div>
              
              {{/* Enhanced property display with better UX */}}
              {{ $propActualSchema := $propSchema }}
              {{ if $propSchema.Value }}
                {{ $propActualSchema = $propSchema.Value }}
              {{ end }}
              
              <div class="property-meta">
                <div class="property-type">
                  {{ with $propActualSchema.Type }}
                    <span class="type-badge type-badge--{{ . }}">{{ . }}</span>
                  {{ end }}
                  {{ with $propActualSchema.Format }}
                    <span class="property-format">{{ . }}</span>
                  {{ end }}
                </div>
              </div>
              
              {{ with $propActualSchema.Description }}
                <div class="property-description">{{ . | markdownify }}</div>
              {{ end }}
              
              {{ if or $propActualSchema.Default $propActualSchema.Example $propActualSchema.Enum }}
                <div class="property-constraints">
                  {{ with $propActualSchema.Default }}
                    <span class="property-constraint">Default: <code>{{ . }}</code></span>
                  {{ end }}
                  {{ with $propActualSchema.Example }}
                    <span class="property-constraint">Example: <code>{{ . }}</code></span>
                  {{ end }}
                  {{ with $propActualSchema.Enum }}
                    <span class="property-constraint">Values: {{ range $i, $val := . }}{{ if $i }}, {{ end }}<code>{{ $val }}</code>{{ end }}</span>
                  {{ end }}
                </div>
              {{ end }}
              
              {{/* For complex nested objects, still render recursively */}}
              {{ if and (eq $propActualSchema.Type "object") $propActualSchema.Properties }}
                <div class="property-schema">
                  {{ partial "openapi/schema.html" (dict "schema" $propSchema "spec" $spec "level" (add $level 1)) }}
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      </div>
    {{ end }}
    
    {{ with $actualSchema.AdditionalProperties }}
      <div class="schema-additional-properties">
        <h6>Additional Properties</h6>
        {{ if eq . true }}
          <div class="additional-properties-any">Any additional properties are allowed</div>
        {{ else if eq . false }}
          <div class="additional-properties-none">No additional properties are allowed</div>
        {{ else }}
          <div class="additional-properties-schema">
            {{ if (reflect.IsMap .) }}
              {{ partial "openapi/schema.html" (dict "schema" . "spec" $spec "level" (add $level 1)) }}
            {{ else }}
              <span class="additional-properties-type">Additional properties of type: {{ printf "%T" . }}</span>
            {{ end }}
          </div>
        {{ end }}
      </div>
    {{ end }}
  
  <!-- Array Items -->
  {{ if or (eq $actualSchema.Type "array") (in $actualSchema.Type "array") }}
    <div class="schema-array-info">
      <h6>Array Information</h6>
      <div class="array-constraints">
        {{ if isset $actualSchema "MinItems" }}{{ with $actualSchema.MinItems }}
          <span class="constraint">
            <span class="constraint-label">Min Items:</span>
            <code>{{ . }}</code>
          </span>
        {{ end }}{{ end }}
        {{ if isset $actualSchema "MaxItems" }}{{ with $actualSchema.MaxItems }}
          <span class="constraint">
            <span class="constraint-label">Max Items:</span>
            <code>{{ . }}</code>
          </span>
        {{ end }}{{ end }}
        {{ if and (isset $actualSchema "UniqueItems") $actualSchema.UniqueItems }}
          <span class="constraint">
            <span class="constraint-label">Unique Items:</span>
            <code>true</code>
          </span>
        {{ end }}
      </div>
      
      {{ with $actualSchema.Items }}
        <div class="schema-array-items">
          <h6>Item Schema</h6>
          <div class="array-item-schema">
            {{ partial "openapi/schema.html" (dict "schema" . "spec" $spec "level" (add $level 1)) }}
          </div>
        </div>
      {{ end }}
    </div>
  {{ end }}
  
  <!-- OneOf/AnyOf/AllOf -->
  {{ with $actualSchema.OneOf }}
    <div class="schema-composition">
      <h6>One Of</h6>
      <div class="composition-list">
        {{ range $index, $subSchema := . }}
          <div class="composition-item">
            <div class="composition-index">Option {{ add $index 1 }}</div>
            {{ partial "openapi/schema.html" (dict "schema" $subSchema "spec" $spec "level" (add $level 1)) }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  
  {{ with $actualSchema.AnyOf }}
    <div class="schema-composition">
      <h6>Any Of</h6>
      <div class="composition-list">
        {{ range $index, $subSchema := . }}
          <div class="composition-item">
            <div class="composition-index">Option {{ add $index 1 }}</div>
            {{ partial "openapi/schema.html" (dict "schema" $subSchema "spec" $spec "level" (add $level 1)) }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  
  {{ with $actualSchema.AllOf }}
    <div class="schema-composition">
      <h6>All Of</h6>
      <div class="composition-list">
        {{ range $index, $subSchema := . }}
          <div class="composition-item">
            <div class="composition-index">Schema {{ add $index 1 }}</div>
            {{ partial "openapi/schema.html" (dict "schema" $subSchema "spec" $spec "level" (add $level 1)) }}
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
</div>