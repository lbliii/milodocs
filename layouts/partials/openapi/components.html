{{- $components := .components -}}
{{- $page := .page -}}

<section class="openapi-components" id="components">
  <div class="section-header">
    <h2 class="section-title">Components</h2>
    <div class="section-description">Reusable components used throughout the API</div>
  </div>
  
  <!-- Schemas -->
  {{ with $components.Schemas }}
    <div class="components-section">
      <h3 class="components-section-title">Schemas</h3>
      <div class="components-list">
        {{ range $schemaName, $schema := . }}
          {{ $sanitizedSchemaName := $schemaName | replace "/" "-" | replace "{" "" | replace "}" "" | replace ":" "" | replace "." "-" | replace " " "-" | urlize }}
          {{ if eq $sanitizedSchemaName "" }}{{ $sanitizedSchemaName = "unnamed" }}{{ end }}
          <div class="component-item" id="schema-{{ $sanitizedSchemaName }}">
            <div class="component-header collapse__header" 
                 data-target="schema-{{ $sanitizedSchemaName }}-details"
                 role="button"
                 tabindex="0"
                 aria-expanded="false">
              <div class="component-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <path d="M14 2v6h6"></path>
                  <path d="M16 13H8"></path>
                  <path d="M16 17H8"></path>
                  <path d="M10 9H8"></path>
                </svg>
              </div>
              <div class="component-name">
                <h4>{{ $schemaName }}</h4>
                {{/* Handle SchemaRef vs direct Schema */}}
                {{ $actualSchema := $schema }}
                {{ if $schema.Value }}
                  {{ $actualSchema = $schema.Value }}
                {{ end }}
                {{ with $actualSchema.Title }}
                  <div class="component-title">{{ . }}</div>
                {{ end }}
                {{ with $actualSchema.Type }}
                  <div class="component-type">
                    <span class="type-badge type-badge--{{ . }}">{{ . }}</span>
                  </div>
                {{ end }}
              </div>
              <div class="component-toggle">
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </div>
            </div>
            
            <div class="component-details" id="schema-{{ $sanitizedSchemaName }}-details">
              {{ partial "openapi/schema.html" (dict "schema" $schema "spec" $.spec "level" 0) }}
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  
  <!-- Security Schemes -->
  {{ with $components.SecuritySchemes }}
    <div class="components-section">
      <h3 class="components-section-title">Security Schemes</h3>
      <div class="components-list">
        {{ range $schemeName, $scheme := . }}
          {{ $sanitizedSchemeName := $schemeName | replace "/" "-" | replace "{" "" | replace "}" "" | replace ":" "" | replace "." "-" | replace " " "-" | urlize }}
          {{ if eq $sanitizedSchemeName "" }}{{ $sanitizedSchemeName = "unnamed" }}{{ end }}
          <div class="component-item" id="security-{{ $sanitizedSchemeName }}">
            <div class="component-header collapse__header" 
                 data-target="security-{{ $sanitizedSchemeName }}-details"
                 role="button"
                 tabindex="0"
                 aria-expanded="false">
              <div class="component-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
              </div>
              <div class="component-name">
                <h4>{{ $schemeName }}</h4>
                <div class="component-type">
                  <span class="type-badge type-badge--security">{{ $scheme.type }}</span>
                </div>
              </div>
              <div class="component-toggle">
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </div>
            </div>
            
            <div class="component-details" id="security-{{ $sanitizedSchemeName }}-details">
              {{ with $scheme.description }}
                <div class="security-description">{{ . | markdownify }}</div>
              {{ end }}
              
              <div class="security-details">
                <div class="security-detail">
                  <span class="detail-label">Type:</span>
                  <code>{{ $scheme.type }}</code>
                </div>
                
                {{ if eq $scheme.type "http" }}
                  <div class="security-detail">
                    <span class="detail-label">Scheme:</span>
                    <code>{{ $scheme.scheme }}</code>
                  </div>
                  {{ with $scheme.bearerFormat }}
                    <div class="security-detail">
                      <span class="detail-label">Bearer Format:</span>
                      <code>{{ . }}</code>
                    </div>
                  {{ end }}
                {{ end }}
                
                {{ if eq $scheme.type "apiKey" }}
                  <div class="security-detail">
                    <span class="detail-label">Parameter Name:</span>
                    <code>{{ $scheme.name }}</code>
                  </div>
                  <div class="security-detail">
                    <span class="detail-label">Location:</span>
                    <code>{{ $scheme.in }}</code>
                  </div>
                {{ end }}
                
                {{ if eq $scheme.type "openIdConnect" }}
                  <div class="security-detail">
                    <span class="detail-label">OpenID Connect URL:</span>
                    <a href="{{ $scheme.openIdConnectUrl }}" target="_blank" rel="noopener">{{ $scheme.openIdConnectUrl }}</a>
                  </div>
                {{ end }}
                
                {{ if eq $scheme.type "oauth2" }}
                  {{ with $scheme.flows }}
                    <div class="oauth-flows">
                      <h5>OAuth2 Flows</h5>
                      {{ range $flowType, $flow := . }}
                        <div class="oauth-flow">
                          <div class="flow-header">{{ title $flowType }} Flow</div>
                          {{ with $flow.authorizationUrl }}
                            <div class="security-detail">
                              <span class="detail-label">Authorization URL:</span>
                              <a href="{{ . }}" target="_blank" rel="noopener">{{ . }}</a>
                            </div>
                          {{ end }}
                          {{ with $flow.tokenUrl }}
                            <div class="security-detail">
                              <span class="detail-label">Token URL:</span>
                              <a href="{{ . }}" target="_blank" rel="noopener">{{ . }}</a>
                            </div>
                          {{ end }}
                          {{ with $flow.refreshUrl }}
                            <div class="security-detail">
                              <span class="detail-label">Refresh URL:</span>
                              <a href="{{ . }}" target="_blank" rel="noopener">{{ . }}</a>
                            </div>
                          {{ end }}
                          {{ with $flow.scopes }}
                            <div class="oauth-scopes">
                              <div class="detail-label">Available Scopes:</div>
                              <div class="scopes-list">
                                {{ range $scope, $description := . }}
                                  <div class="scope-item">
                                    <code>{{ $scope }}</code>
                                    <span class="scope-description">{{ $description }}</span>
                                  </div>
                                {{ end }}
                              </div>
                            </div>
                          {{ end }}
                        </div>
                      {{ end }}
                    </div>
                  {{ end }}
                {{ end }}
              </div>
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  
  <!-- Response Objects -->
  {{ with $components.Responses }}
    <div class="components-section">
      <h3 class="components-section-title">Response Objects</h3>
      <div class="components-list">
        {{ range $responseName, $response := . }}
          {{ $sanitizedResponseName := $responseName | replace "/" "-" | replace "{" "" | replace "}" "" | replace ":" "" | replace "." "-" | replace " " "-" | urlize }}
          {{ if eq $sanitizedResponseName "" }}{{ $sanitizedResponseName = "unnamed" }}{{ end }}
          <div class="component-item" id="response-{{ $sanitizedResponseName }}">
            <div class="component-header collapse__header" 
                 data-target="response-{{ $sanitizedResponseName }}-details"
                 role="button"
                 tabindex="0"
                 aria-expanded="false">
              <div class="component-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <path d="M7 10l5 5 5-5"></path>
                  <path d="M12 15V3"></path>
                </svg>
              </div>
              <div class="component-name">
                <h4>{{ $responseName }}</h4>
                <div class="component-description">{{ $response.description }}</div>
              </div>
              <div class="component-toggle">
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </div>
            </div>
            
            <div class="component-details" id="response-{{ $sanitizedResponseName }}-details">
              {{ partial "openapi/endpoint-responses.html" (dict "responses" (dict "200" $response) "spec" $.spec) }}
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
  
  <!-- Parameters -->
  {{ with $components.Parameters }}
    <div class="components-section">
      <h3 class="components-section-title">Parameters</h3>
      <div class="components-list">
        {{ range $paramName, $param := . }}
          {{ $sanitizedParamName := $paramName | replace "/" "-" | replace "{" "" | replace "}" "" | replace ":" "" | replace "." "-" | replace " " "-" | urlize }}
          {{ if eq $sanitizedParamName "" }}{{ $sanitizedParamName = "unnamed" }}{{ end }}
          <div class="component-item" id="parameter-{{ $sanitizedParamName }}">
            <div class="component-header collapse__header" 
                 data-target="parameter-{{ $sanitizedParamName }}-details"
                 role="button"
                 tabindex="0"
                 aria-expanded="false">
              <div class="component-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M7 7h.01"></path>
                  <path d="M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 0 1 0 2.828l-7 7a1.994 1.994 0 0 1-1.414.586H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                </svg>
              </div>
              <div class="component-name">
                <h4>{{ $paramName }}</h4>
                <div class="component-meta">
                  <span class="param-location">{{ $param.in }}</span>
                  {{ if $param.required }}
                    <span class="param-required">required</span>
                  {{ end }}
                </div>
              </div>
              <div class="component-toggle">
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </div>
            </div>
            
            <div class="component-details" id="parameter-{{ $sanitizedParamName }}-details">
              {{ partial "openapi/endpoint-parameters.html" (dict "parameters" (slice $param) "spec" $.spec) }}
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  {{ end }}
</section>