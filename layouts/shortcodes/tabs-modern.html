{{- $id := .Get "id" | default (printf "tabs-%s" (md5 .Inner)) -}}
{{- $tabs := .Params.tabs -}}

{{- if not $tabs -}}
  {{- errorf "tabs-modern shortcode requires 'tabs' parameter with tab definitions" -}}
{{- end -}}

<div class="tabs-modern" id="{{ $id }}">
  <!-- Tab navigation -->
  <div class="tabs-modern__nav" role="tablist">
    {{- range $index, $tab := $tabs -}}
      {{- $tabId := printf "%s-tab-%d" $id $index -}}
      {{- $panelId := printf "%s-panel-%d" $id $index -}}
      {{- $isActive := and (eq $index 0) (not $tab.active) -}}
      {{- if $tab.active -}}
        {{- $isActive = true -}}
      {{- end -}}
      
      <label for="{{ $tabId }}" 
             class="tabs-modern__button"
             role="tab"
             aria-controls="{{ $panelId }}"
             aria-selected="{{ if $isActive }}true{{ else }}false{{ end }}"
             tabindex="{{ if $isActive }}0{{ else }}-1{{ end }}">
        {{ $tab.title }}
      </label>
      
      <input type="radio" 
             id="{{ $tabId }}"
             name="{{ $id }}-tabs"
             class="tabs-modern__radio"
             {{ if $isActive }}checked{{ end }}
             aria-hidden="true">
    {{- end -}}
  </div>
  
  <!-- Tab content -->
  <div class="tabs-modern__content">
    {{- range $index, $tab := $tabs -}}
      {{- $panelId := printf "%s-panel-%d" $id $index -}}
      <div id="{{ $panelId }}"
           class="tabs-modern__panel"
           role="tabpanel"
           aria-hidden="{{ if and (eq $index 0) (not $tab.active) }}false{{ else if $tab.active }}false{{ else }}true{{ end }}">
        {{ $tab.content | markdownify }}
      </div>
    {{- end -}}
  </div>
</div>

<script>
// Enhanced keyboard navigation for accessibility
(function() {
  const tabsContainer = document.getElementById('{{ $id }}');
  if (!tabsContainer) return;
  
  const tabButtons = tabsContainer.querySelectorAll('.tabs-modern__button');
  const radioInputs = tabsContainer.querySelectorAll('.tabs-modern__radio');
  
  tabButtons.forEach((button, index) => {
    button.addEventListener('click', () => {
      // Update radio state
      radioInputs[index].checked = true;
      
      // Update aria attributes
      tabButtons.forEach((btn, i) => {
        btn.setAttribute('aria-selected', i === index ? 'true' : 'false');
        btn.setAttribute('tabindex', i === index ? '0' : '-1');
      });
      
      // Update panel visibility for screen readers
      const panels = tabsContainer.querySelectorAll('.tabs-modern__panel');
      panels.forEach((panel, i) => {
        panel.setAttribute('aria-hidden', i === index ? 'false' : 'true');
      });
    });
    
    // Keyboard navigation
    button.addEventListener('keydown', (e) => {
      let newIndex = index;
      
      switch(e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          newIndex = (index + 1) % tabButtons.length;
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          newIndex = (index - 1 + tabButtons.length) % tabButtons.length;
          break;
        case 'Home':
          newIndex = 0;
          break;
        case 'End':
          newIndex = tabButtons.length - 1;
          break;
        default:
          return;
      }
      
      e.preventDefault();
      tabButtons[newIndex].click();
      tabButtons[newIndex].focus();
    });
  });
})();
</script>