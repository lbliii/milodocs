<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notebook Component Split Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .test-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .test-pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        /* Basic notebook styles for testing */
        .notebook {
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            margin: 20px 0;
        }
        
        .notebook-cell {
            border-bottom: 1px solid #eee;
            padding: 16px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .notebook-cell:last-child {
            border-bottom: none;
        }
        
        .notebook-cell--code {
            background: #f8f9fa;
        }
        
        .notebook-cell--markdown {
            background: white;
        }
        
        .notebook-cell--collapsed .notebook-cell__content {
            display: none;
        }
        
        .notebook-cell__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            cursor: pointer;
            border-radius: 4px;
            padding: 8px;
            margin: -8px;
            transition: background-color 0.2s;
        }
        
        .notebook-cell__header:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .notebook-cell__type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .notebook-cell__type-icon {
            width: 16px;
            height: 16px;
        }
        
        .notebook-cell__controls {
            display: flex;
            gap: 8px;
        }
        
        .notebook-cell__toggle,
        .notebook-cell__copy-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .notebook-cell__toggle:hover,
        .notebook-cell__copy-btn:hover {
            background: #0056b3;
        }
        
        .notebook-cell__content {
            margin-top: 12px;
        }
        
        .notebook-cell__code-container {
            position: relative;
            background: #f8f8f8;
            border-radius: 4px;
            padding: 16px;
            margin: 8px 0;
        }
        
        pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .test-controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .test-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #218838;
        }
        
        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>üß™ Notebook Component Split Test</h1>
    <p>Testing the refactored NotebookViewer components to ensure all functionality works correctly.</p>
    
    <div class="test-controls">
        <button class="test-btn" onclick="runAllTests()">Run All Tests</button>
        <button class="test-btn" onclick="resetTest()">Reset Test</button>
        <button class="test-btn" onclick="toggleTestNotebook()">Toggle All Cells</button>
    </div>
    
    <div id="test-results">
        <div class="test-status test-pending" id="component-load-status">
            ‚è≥ Component Loading: Pending
        </div>
        <div class="test-status test-pending" id="cell-setup-status">
            ‚è≥ Cell Setup: Pending
        </div>
        <div class="test-status test-pending" id="navigation-status">
            ‚è≥ Navigation: Pending
        </div>
        <div class="test-status test-pending" id="state-status">
            ‚è≥ State Management: Pending
        </div>
        <div class="test-status test-pending" id="copy-status">
            ‚è≥ Copy Functionality: Pending
        </div>
        <div class="test-status test-pending" id="accessibility-status">
            ‚è≥ Accessibility: Pending
        </div>
    </div>

    <!-- Test Notebook -->
    <div class="test-section">
        <h2>Test Notebook</h2>
        <div class="notebook" id="test-notebook">
            
            <!-- Markdown Cell -->
            <div class="notebook-cell" data-cell-type="markdown">
                <div class="notebook-cell__content">
                    <h3>Test Markdown Cell</h3>
                    <p>This is a markdown cell to test the split components.</p>
                    <ul>
                        <li>Cell detection should work</li>
                        <li>Headers should be added automatically</li>
                        <li>Navigation should work with keyboard</li>
                    </ul>
                </div>
            </div>

            <!-- Code Cell -->
            <div class="notebook-cell" data-cell-type="code">
                <div class="notebook-cell__content">
                    <div class="notebook-cell__code-container">
                        <pre><code># Python test code
import numpy as np
import pandas as pd

# Create test data
data = np.random.randn(100, 3)
df = pd.DataFrame(data, columns=['A', 'B', 'C'])

print("DataFrame shape:", df.shape)
print(df.head())</code></pre>
                    </div>
                    <div class="notebook-cell__outputs">
                        <div class="notebook-cell__output notebook-cell__output--stream">
                            <pre>DataFrame shape: (100, 3)
     A         B         C
0  1.234    -0.567     0.890
1 -0.123     1.456    -0.789
2  0.456    -1.234     0.567
3 -0.789     0.123     1.234
4  1.567    -0.890     0.123</pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Another Code Cell -->
            <div class="notebook-cell" data-cell-type="code">
                <div class="notebook-cell__content">
                    <div class="notebook-cell__code-container">
                        <pre><code># Another test code cell
import matplotlib.pyplot as plt

# Create a simple plot
plt.figure(figsize=(8, 6))
plt.plot([1, 2, 3, 4], [1, 4, 2, 3])
plt.title('Test Plot')
plt.xlabel('X axis')
plt.ylabel('Y axis')
plt.show()</code></pre>
                    </div>
                </div>
            </div>

            <!-- Raw Cell -->
            <div class="notebook-cell" data-cell-type="raw">
                <div class="notebook-cell__content">
                    <div class="raw-cell-content">
                        This is a raw cell for testing.
                        It should be detected and handled correctly.
                        
                        Raw cells don't execute - they're just text.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="test-log" style="background: white; padding: 15px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
            <div>Waiting for tests to start...</div>
        </div>
    </div>

    <!-- Load the components -->
    <script type="module">
        // Import the core system and components
        import { ComponentManager } from './assets/js/core/ComponentManager.js';
        import { MiloCore } from './assets/js/core/MiloCore.js';
        
        // Import the split notebook components (now properly organized under notebook/)
        import './assets/js/components/notebook/NotebookViewer.js';
        import './assets/js/components/notebook/NotebookCell.js';
        import './assets/js/components/notebook/NotebookNavigation.js';
        import './assets/js/components/notebook/NotebookState.js';

        // Test utilities
        window.testLog = [];
        window.testResults = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            window.testLog.push(logEntry);
            
            const logDiv = document.getElementById('test-log');
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
            logDiv.appendChild(logElement);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function updateTestStatus(testId, status, message) {
            window.testResults[testId] = status;
            const element = document.getElementById(testId + '-status');
            if (element) {
                element.className = `test-status test-${status}`;
                element.textContent = `${status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥'} ${message}`;
            }
        }

        // Test functions
        async function testComponentLoading() {
            log('Testing component loading...');
            
            try {
                // Check if components are registered
                const registered = ComponentManager.getRegistered();
                const requiredComponents = [
                    'notebook-viewer', 
                    'notebook-cell', 
                    'notebook-navigation', 
                    'notebook-state'
                ];
                
                let allRegistered = true;
                for (const comp of requiredComponents) {
                    if (!registered.includes(comp)) {
                        log(`Component ${comp} not registered`, 'error');
                        allRegistered = false;
                    } else {
                        log(`Component ${comp} registered successfully`, 'success');
                    }
                }
                
                if (allRegistered) {
                    updateTestStatus('component-load', 'pass', 'Component Loading: All components registered');
                    return true;
                } else {
                    updateTestStatus('component-load', 'fail', 'Component Loading: Some components missing');
                    return false;
                }
                
            } catch (error) {
                log(`Component loading error: ${error.message}`, 'error');
                updateTestStatus('component-load', 'fail', 'Component Loading: Failed with error');
                return false;
            }
        }

        async function testCellSetup() {
            log('Testing cell setup and detection...');
            
            try {
                // Create and initialize notebook viewer
                const notebookElement = document.getElementById('test-notebook');
                const notebookViewer = ComponentManager.create('notebook-viewer', {
                    selector: '#test-notebook'
                });
                
                // Initialize the component
                await notebookViewer.init();
                
                // Check if cells were detected and set up
                const cells = notebookElement.querySelectorAll('.notebook-cell');
                const cellsWithHeaders = notebookElement.querySelectorAll('.notebook-cell__header');
                const cellsWithContent = notebookElement.querySelectorAll('.notebook-cell__content');
                
                log(`Found ${cells.length} cells`, 'info');
                log(`Found ${cellsWithHeaders.length} cell headers`, 'info');
                log(`Found ${cellsWithContent.length} cell content wrappers`, 'info');
                
                if (cells.length === cellsWithHeaders.length && cells.length === cellsWithContent.length) {
                    updateTestStatus('cell-setup', 'pass', 'Cell Setup: All cells properly structured');
                    window.notebookViewer = notebookViewer; // Store for other tests
                    return true;
                } else {
                    updateTestStatus('cell-setup', 'fail', 'Cell Setup: Cell structure incomplete');
                    return false;
                }
                
            } catch (error) {
                log(`Cell setup error: ${error.message}`, 'error');
                updateTestStatus('cell-setup', 'fail', 'Cell Setup: Failed with error');
                return false;
            }
        }

        async function testNavigation() {
            log('Testing keyboard navigation...');
            
            try {
                const headers = document.querySelectorAll('.notebook-cell__header[tabindex]');
                log(`Found ${headers.length} focusable headers`, 'info');
                
                if (headers.length > 0) {
                    // Test focus management
                    const firstHeader = headers[0];
                    firstHeader.focus();
                    
                    // Simulate arrow key navigation
                    const keyEvent = new KeyboardEvent('keydown', {
                        key: 'ArrowDown',
                        bubbles: true,
                        cancelable: true
                    });
                    
                    firstHeader.dispatchEvent(keyEvent);
                    
                    // Check if ARIA attributes are set
                    const ariaLabels = document.querySelectorAll('[aria-label*="Jupyter"]');
                    const ariaControls = document.querySelectorAll('[aria-controls]');
                    
                    log(`Found ${ariaLabels.length} ARIA labels`, 'info');
                    log(`Found ${ariaControls.length} ARIA controls`, 'info');
                    
                    updateTestStatus('navigation', 'pass', 'Navigation: Keyboard and ARIA setup working');
                    return true;
                } else {
                    updateTestStatus('navigation', 'fail', 'Navigation: No focusable headers found');
                    return false;
                }
                
            } catch (error) {
                log(`Navigation test error: ${error.message}`, 'error');
                updateTestStatus('navigation', 'fail', 'Navigation: Failed with error');
                return false;
            }
        }

        async function testStateManagement() {
            log('Testing state management...');
            
            try {
                if (!window.notebookViewer) {
                    throw new Error('NotebookViewer not available');
                }
                
                // Test collapse/expand functionality
                const toggleButton = document.querySelector('.notebook-cell__toggle');
                if (toggleButton) {
                    // Simulate click to collapse
                    toggleButton.click();
                    
                    // Check if cell collapsed
                    const collapsedCells = document.querySelectorAll('.notebook-cell--collapsed');
                    log(`Found ${collapsedCells.length} collapsed cells after toggle`, 'info');
                    
                    // Test expand
                    toggleButton.click();
                    
                    // Test stats
                    const stats = window.notebookViewer.getStats();
                    log(`Notebook stats: ${JSON.stringify(stats)}`, 'info');
                    
                    updateTestStatus('state', 'pass', 'State Management: Collapse/expand and stats working');
                    return true;
                } else {
                    updateTestStatus('state', 'fail', 'State Management: No toggle buttons found');
                    return false;
                }
                
            } catch (error) {
                log(`State management error: ${error.message}`, 'error');
                updateTestStatus('state', 'fail', 'State Management: Failed with error');
                return false;
            }
        }

        async function testCopyFunctionality() {
            log('Testing copy functionality...');
            
            try {
                const copyButtons = document.querySelectorAll('.notebook-cell__copy-btn');
                log(`Found ${copyButtons.length} copy buttons`, 'info');
                
                if (copyButtons.length > 0) {
                    // Test copy button click (won't actually copy due to permissions, but should not error)
                    const copyButton = copyButtons[0];
                    
                    // Mock clipboard API for testing
                    const originalWriteText = navigator.clipboard?.writeText;
                    let copyAttempted = false;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText = async (text) => {
                            copyAttempted = true;
                            log(`Copy attempted with text length: ${text.length}`, 'info');
                            return Promise.resolve();
                        };
                    }
                    
                    // Simulate copy click
                    copyButton.click();
                    
                    // Restore original function
                    if (originalWriteText) {
                        navigator.clipboard.writeText = originalWriteText;
                    }
                    
                    updateTestStatus('copy', 'pass', 'Copy Functionality: Copy buttons working');
                    return true;
                } else {
                    updateTestStatus('copy', 'fail', 'Copy Functionality: No copy buttons found');
                    return false;
                }
                
            } catch (error) {
                log(`Copy functionality error: ${error.message}`, 'error');
                updateTestStatus('copy', 'fail', 'Copy Functionality: Failed with error');
                return false;
            }
        }

        async function testAccessibility() {
            log('Testing accessibility features...');
            
            try {
                // Check for screen reader announcements
                const srElements = document.querySelectorAll('.sr-only');
                log(`Found ${srElements.length} screen reader elements`, 'info');
                
                // Check ARIA attributes
                const ariaExpanded = document.querySelectorAll('[aria-expanded]');
                const ariaControls = document.querySelectorAll('[aria-controls]');
                const ariaLabels = document.querySelectorAll('[aria-label]');
                
                log(`Found ${ariaExpanded.length} aria-expanded elements`, 'info');
                log(`Found ${ariaControls.length} aria-controls elements`, 'info');
                log(`Found ${ariaLabels.length} aria-label elements`, 'info');
                
                // Check role attributes
                const roles = document.querySelectorAll('[role]');
                log(`Found ${roles.length} role attributes`, 'info');
                
                if (srElements.length > 0 && ariaExpanded.length > 0) {
                    updateTestStatus('accessibility', 'pass', 'Accessibility: ARIA and screen reader support working');
                    return true;
                } else {
                    updateTestStatus('accessibility', 'fail', 'Accessibility: Missing accessibility features');
                    return false;
                }
                
            } catch (error) {
                log(`Accessibility test error: ${error.message}`, 'error');
                updateTestStatus('accessibility', 'fail', 'Accessibility: Failed with error');
                return false;
            }
        }

        // Global test functions
        window.runAllTests = async function() {
            log('Starting comprehensive component tests...', 'info');
            
            // Reset test log
            document.getElementById('test-log').innerHTML = '<div>Starting tests...</div>';
            window.testLog = [];
            window.testResults = {};
            
            const tests = [
                { name: 'Component Loading', fn: testComponentLoading },
                { name: 'Cell Setup', fn: testCellSetup },
                { name: 'Navigation', fn: testNavigation },
                { name: 'State Management', fn: testStateManagement },
                { name: 'Copy Functionality', fn: testCopyFunctionality },
                { name: 'Accessibility', fn: testAccessibility }
            ];
            
            let passedTests = 0;
            let totalTests = tests.length;
            
            for (const test of tests) {
                log(`Running ${test.name} test...`, 'info');
                try {
                    const result = await test.fn();
                    if (result) {
                        passedTests++;
                        log(`${test.name} test passed ‚úÖ`, 'success');
                    } else {
                        log(`${test.name} test failed ‚ùå`, 'error');
                    }
                } catch (error) {
                    log(`${test.name} test threw error: ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log(`\n=== TEST SUMMARY ===`, 'info');
            log(`Passed: ${passedTests}/${totalTests} tests`, passedTests === totalTests ? 'success' : 'error');
            
            if (passedTests === totalTests) {
                log('üéâ All tests passed! Component split is working correctly.', 'success');
            } else {
                log('‚ö†Ô∏è Some tests failed. Component split needs attention.', 'error');
            }
        };

        window.resetTest = function() {
            location.reload();
        };

        window.toggleTestNotebook = function() {
            if (window.notebookViewer) {
                window.notebookViewer.toggleAllCells();
                log('Toggled all notebook cells', 'info');
            } else {
                log('NotebookViewer not available for toggle', 'error');
            }
        };

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded, running tests automatically...', 'info');
                window.runAllTests();
            }, 1000);
        });

    </script>
</body>
</html>